package com.webweeb.backend.utils;import com.webweeb.backend.entity.LoginHistory;import com.webweeb.backend.entity.User;import jakarta.mail.internet.MimeMessage;import lombok.RequiredArgsConstructor;import org.springframework.beans.factory.annotation.Value;import org.springframework.mail.javamail.JavaMailSender;import org.springframework.mail.javamail.MimeMessageHelper;import org.springframework.stereotype.Service;import java.net.URLEncoder;import java.nio.charset.StandardCharsets;import java.time.format.DateTimeFormatter;@Service@RequiredArgsConstructorpublic class Mail {    private final JavaMailSender mailSender;    @Value("${spring.google.maps.api.key}")    private String googleMapsApiKey;    public void sendLoginNotification(User user, LoginHistory loginHistory) {        String subject = "üîí Security Alert: New Login to Your Account";        // Format date & time        String formattedTime = loginHistory.getCreatedAt()                .format(DateTimeFormatter.ofPattern("EEEE, MMM dd yyyy HH:mm:ss"));        // Generate Google Maps Image URL        String locationQuery = URLEncoder.encode(loginHistory.getLocation(), StandardCharsets.UTF_8);        String googleMapsUrl = "https://www.google.com/maps/search/?api=1&query=" + locationQuery;        String googleMapsImage = "https://maps.googleapis.com/maps/api/staticmap?center="                + locationQuery + "&zoom=14&size=600x300&markers=color:red%7C" + locationQuery                + "&key=" + googleMapsApiKey;        String message = "<html><body>" +                "<h2 style='color:#ff4500;'>üö® Security Alert</h2>" +                "<p>Dear <b>" + user.getUsername() + "</b>,</p>" +                "<p>A new login to your account was detected:</p>" +                "<ul>" +                "<li>üìç <b>Location:</b> " + loginHistory.getLocation() + "</li>" +                "<li>üíª <b>Device:</b> " + loginHistory.getDeviceName() + " (" + loginHistory.getDeviceType() + ")</li>" +                "<li>üåê <b>Browser:</b> " + loginHistory.getBrowserName() + " (" + loginHistory.getBrowserVersion() + ")</li>" +                "<li>üïí <b>Time:</b> " + formattedTime + "</li>" +                "</ul>" +                "<p><b>Location on Map:</b></p>" +                "<a href='" + googleMapsUrl + "' target='_blank'>" +                "<img src='" + googleMapsImage + "' alt='Login Location' style='border-radius:10px; width:100%; max-width:600px;'/></a>" +                "<p>If this was you, no further action is needed.</p>" +                "<p>If this was <b>not</b> you, please change your password immediately.</p>" +                "<p style='color:red;'>‚ö†Ô∏è Stay safe, and enable 2FA for extra security.</p>" +                "<p>Best Regards,<br><b>Your Security Team</b></p>" +                "</body></html>";        try {            MimeMessage mailMessage = mailSender.createMimeMessage();            MimeMessageHelper helper = new MimeMessageHelper(mailMessage, true, "UTF-8");            helper.setTo(user.getEmail());            helper.setSubject(subject);            helper.setText(message, true);            mailSender.send(mailMessage);        } catch (Exception e) {            e.fillInStackTrace();        }    }}